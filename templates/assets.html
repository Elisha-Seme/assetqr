{% extends "base.html" %}
{% block title %}Assets — AssetQR{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1 class="page-title">Assets</h1>
    <p class="page-sub" id="asset-count">{{ assets|length }} asset{{ 's' if assets|length != 1 }}</p>
  </div>
  <div class="header-actions">
    <button class="btn btn-primary" onclick="openAddModal()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
      </svg>
      Add Asset
    </button>
    <div class="dropdown">
      <button class="btn btn-ghost" id="export-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Export
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;margin-left:2px">
          <polyline points="6 9 12 15 18 9"/>
        </svg>
      </button>
      <div class="dropdown-menu" id="export-menu">
        <a class="dropdown-item" onclick="exportAction('pdf')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/>
          </svg>
          PDF Table
        </a>
        <a class="dropdown-item" onclick="exportAction('labels')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
            <rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/>
            <rect x="3" y="14" width="7" height="7" rx="1"/>
            <path d="M14 14h2v2h-2zM18 14h3M14 18h2M18 18h3M14 21h5"/>
          </svg>
          QR Label Sheet
        </a>
        <a class="dropdown-item" onclick="exportAction('csv')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/>
            <line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="16" y2="17"/>
          </svg>
          CSV
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Filter bar -->
<form method="get" class="filter-bar" id="filter-form">
  <div class="search-wrap">
    <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
    </svg>
    <input type="text" name="q" value="{{ q }}" placeholder="Search name, ID, location…" class="search-input" id="search-input" autocomplete="off">
    {% if q %}<button type="button" class="search-clear" onclick="clearSearch()">×</button>{% endif %}
  </div>
  <select name="cat" class="filter-select" onchange="this.form.submit()">
    <option value="">All Categories</option>
    {% for c in cats %}
    <option value="{{ c }}"{% if c == cat %} selected{% endif %}>{{ c }}</option>
    {% endfor %}
  </select>
  <select name="status" class="filter-select" onchange="this.form.submit()">
    <option value="">All Statuses</option>
    <option value="active"{% if status == 'active' %} selected{% endif %}>Active</option>
    <option value="maintenance"{% if status == 'maintenance' %} selected{% endif %}>Maintenance</option>
    <option value="retired"{% if status == 'retired' %} selected{% endif %}>Retired</option>
  </select>
  {% if q or cat or status %}
  <a href="{{ url_for('assets_page') }}" class="btn btn-ghost btn--sm">Clear filters</a>
  {% endif %}
</form>

<!-- Bulk action bar (hidden until selection) -->
<div id="bulk-bar" class="bulk-bar" style="display:none">
  <span id="bulk-count">0 selected</span>
  <button class="btn btn-ghost btn--sm" onclick="exportAction('pdf', true)">Export PDF</button>
  <button class="btn btn-ghost btn--sm" onclick="exportAction('labels', true)">Export Labels</button>
  <button class="btn btn-danger btn--sm" onclick="bulkDelete()">Delete Selected</button>
</div>

{% if assets %}
<div class="card" style="margin-top:0">
  <div class="table-wrap">
    <table class="table" id="asset-table">
      <thead>
        <tr>
          <th class="th-check"><input type="checkbox" id="select-all" onchange="toggleAll(this)"></th>
          <th class="th-qr">QR</th>
          <th>Asset ID</th>
          <th>Name</th>
          <th class="col-sm-hide">Category</th>
          <th>Location</th>
          <th>Status</th>
          <th class="col-sm-hide">Serial No.</th>
          <th class="th-actions">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for a in assets %}
        <tr data-id="{{ a.id }}" data-asset-id="{{ a.asset_id }}">
          <td class="td-check"><input type="checkbox" class="row-check" onchange="updateBulkBar()"></td>
          <td class="td-qr">
            {% if a.qr_code_path %}
            <img src="{{ url_for('static', filename='qrcodes/qr_' + a.asset_id + '.png') }}"
                 alt="QR" class="qr-thumb"
                 onclick="showQR('{{ a.asset_id }}', '{{ url_for('static', filename='qrcodes/qr_' + a.asset_id + '.png') }}', '{{ a.name|e }}')"
                 onerror="this.style.display='none'">
            {% else %}
            <span class="qr-missing">—</span>
            {% endif %}
          </td>
          <td><code class="code-id">{{ a.asset_id }}</code></td>
          <td class="td-name">
            <a href="{{ url_for('asset_detail', asset_id=a.asset_id) }}" target="_blank" class="asset-link">{{ a.name }}</a>
            {% if a.description %}<div class="td-sub">{{ a.description[:60] }}{% if a.description|length > 60 %}…{% endif %}</div>{% endif %}
          </td>
          <td class="col-sm-hide">{{ a.category or '—' }}</td>
          <td>{{ a.location or '—' }}</td>
          <td><span class="badge badge--{{ a.status }}">{{ a.status }}</span></td>
          <td class="td-mono col-sm-hide">{{ a.serial_number or '—' }}</td>
          <td class="td-actions">
            <button class="icon-btn" title="Edit" onclick="openEditModal({{ a.id }})">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
            </button>
            <button class="icon-btn icon-btn--danger" title="Delete" onclick="openDeleteModal({{ a.id }}, '{{ a.name|e }}')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a1 1 0 011-1h4a1 1 0 011 1v2"/>
              </svg>
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% else %}
<div class="empty-page">
  <div class="empty-icon">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/>
      <rect x="3" y="14" width="7" height="7" rx="1"/>
      <path d="M14 14h2v2h-2zM18 14h3M14 18h2M18 18h3M14 21h5"/>
    </svg>
  </div>
  <h2>No assets found</h2>
  <p>{% if q or cat or status %}No assets match your filters.{% else %}Get started by adding assets or importing a list.{% endif %}</p>
  <div style="display:flex;gap:8px;justify-content:center">
    <button class="btn btn-primary" onclick="openAddModal()">Add Asset</button>
    <a href="{{ url_for('import_page') }}" class="btn btn-ghost">Import List</a>
  </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Pass category list to JS for the datalist
const CATEGORIES = {{ cats | tojson }};
document.addEventListener('DOMContentLoaded', () => {
  populateCatList(CATEGORIES);

  // Submit search on Enter
  const si = document.getElementById('search-input');
  if (si) {
    si.addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('filter-form').submit(); });
  }

  // Dropdown toggle
  const expBtn = document.getElementById('export-btn');
  const expMenu = document.getElementById('export-menu');
  if (expBtn) {
    expBtn.addEventListener('click', e => {
      e.stopPropagation();
      expMenu.classList.toggle('open');
    });
    document.addEventListener('click', () => expMenu.classList.remove('open'));
  }
});

function clearSearch() {
  const form = document.getElementById('filter-form');
  const qi = form.querySelector('[name=q]');
  if (qi) qi.value = '';
  form.submit();
}
</script>
{% endblock %}
